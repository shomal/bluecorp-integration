trigger:
  branches:
    include:
      - main  # Trigger on changes to the main branch

pool:
  name: 'Default' #self hosted agent pool

#variables:
# Azure DevOps service connection name
# - name: azureSubscription
#   value: AzureBluecorpConnection
# Resource group
# - name: resourceGroup
#   value: 'bluecorp_service_rg'
# Azure region to deploy resources to
# - name: location
#   value : 'australiaeast'

stages:
  - stage: BuildAndDeploy
    displayName: 'Build and Deploy Bicep Template'
    jobs:
      - job: DeployToAzure
        displayName: 'Deploy to Azure'
        steps:
          # Step 1: Verify Python installation
          - script: |
              python --version
              pip --version
            displayName: 'Verify Python Installation'
            
          # Step 2: Install Python Dependencies
          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install Dependencies'

          # Step 3: Install Azure CLI
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.x'
              addToPath: true

          - script: |
              curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
              sudo apt-get install azure-cli
            displayName: 'Install Azure CLI'

          # Step 4: Log in to Azure
          - task: AzureCLI@2
            inputs:
              azureSubscription: "AzureBluecorpConnection"
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az login --service-principal -u $(AZURESERVICEPRINCIPALUSERNAME) -p $(AZURESERVICEPRINCIPALPASSWORD) --tenant $(TENANTID)
                az account set --subscription "AzureBluecorpConnection"

          # Step 5: Deploy the Bicep template to Azure
          - task: AzureCLI@2
            inputs:
              azureSubscription: "AzureBluecorpConnection"
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az deployment group create \
                  --resource-group bluecorp_service_rg \
                  --template-file infrastructure/azure_template.bicep\
                  --parameters location="australiaeast"

          # Step 6: Post-deployment steps (optional, e.g., notifications, tests)
